"use strict";(self.webpackChunkrscg_examples=self.webpackChunkrscg_examples||[]).push([[2862],{4137:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>f});var r=n(7294);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=r.createContext({}),u=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},p=function(e){var t=u(e.components);return r.createElement(l.Provider,{value:t},e.children)},c="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},d=r.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),c=u(n),d=a,f=c["".concat(l,".").concat(d)]||c[d]||m[d]||i;return n?r.createElement(f,o(o({ref:t},p),{},{components:n})):r.createElement(f,o({ref:t},p))}));function f(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s[c]="string"==typeof e?e:a,o[1]=s;for(var u=2;u<i;u++)o[u]=n[u];return r.createElement.apply(null,o)}return r.createElement.apply(null,n)}d.displayName="MDXCreateElement"},5573:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>m,frontMatter:()=>i,metadata:()=>s,toc:()=>u});var r=n(7462),a=(n(7294),n(4137));const i={},o="AOT.Reflection is faster reflection powered via Source Generators",s={unversionedId:"RSCG-Examples/ApparatusAOT_readme",id:"RSCG-Examples/ApparatusAOT_readme",title:"AOT.Reflection is faster reflection powered via Source Generators",description:"This library aims to create a subset of reflection that will be faster than the default one and will not break at the platforms with the AOT compilation support. The source generators will help us with that.",source:"@site/docs/RSCG-Examples/ApparatusAOT_readme.md",sourceDirName:"RSCG-Examples",slug:"/RSCG-Examples/ApparatusAOT_readme",permalink:"/RSCG_Examples/v2/docs/RSCG-Examples/ApparatusAOT_readme",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"37 - AutoRegisterInject",permalink:"/RSCG_Examples/v2/docs/AutoRegisterInject"},next:{title:"AutoCtor_readme",permalink:"/RSCG_Examples/v2/docs/RSCG-Examples/AutoCtor_readme"}},l={},u=[],p={toc:u},c="wrapper";function m(e){let{components:t,...n}=e;return(0,a.kt)(c,(0,r.Z)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"aotreflection-is-faster-reflection-powered-via-source-generators"},"AOT.Reflection is faster reflection powered via Source Generators"),(0,a.kt)("p",null,"This library aims to create a subset of reflection that will be faster than the default one and will not break at the platforms with the AOT compilation support. The source generators will help us with that."),(0,a.kt)("h1",{id:"how-to-use"},"How to use"),(0,a.kt)("p",null,"To make it work, you will need to install a NuGet package ",(0,a.kt)("inlineCode",{parentName:"p"},"Apparatus.AOT.Reflection"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"dotnet add package Apparatus.AOT.Reflection\n")),(0,a.kt)("p",null,"Then you can use it like that:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cs"},"public class User\n{\n    [Required]\n    public string FirstName { get; set; }\n    [Required]\n    public string LastName { get; set; }\n}\n\npublic static void Main()\n{\n    var user = new User();\n    var properties = user.GetProperties().Values;\n    foreach (var property in properties)\n    {\n        Console.WriteLine(property.Name);\n    }\n}\n")),(0,a.kt)("p",null,"This sample will print the names of properties."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"FirstName\nLastName\n")),(0,a.kt)("p",null,"Also, it works for enums too:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cs"},"\npublic enum UserKind \n{\n    User,\n    Admin\n}\n\n// ...\n\npublic static void Main()\n{\n    var values = EnumHelper.GetEnumInfo<UserKind>();\n    foreach (var value in values)\n    {\n        Console.WriteLine(value.Name);\n    }\n}\n\n")),(0,a.kt)("p",null,"You will see:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"User\nAdmin\n")),(0,a.kt)("p",null,"It does not end with the only property names. You can get property values and assigned attributes. "),(0,a.kt)("p",null,"Here is an example:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cs"},'var requiredProperties = _user\n    .GetProperties()\n    .Values\n    .Where(o => o.Attributes.Any(attr => attr is RequiredAttribute))\n    .ToArray();\n\nforeach (var requiredProperty in requiredProperties)\n{\n    if (requiredProperty.TryGetValue(_user, out var value))\n    {\n        Console.WriteLine($"{requiredProperty.Name} => {value}");\n    }\n}\n')),(0,a.kt)("p",null,"The same applies to enums too. Let have a look at the following sample:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cs"},'public enum AccountKind\n{\n    [Description("User account")]\n    User,\n    [Description("Admin account")]\n    Admin,\n    [Description("Customer account")]\n    Customer,\n    [Description("Manager account")]\n    Manager\n}\n\n// ...\n\nvar values = EnumHelper.GetEnumInfo<AccountKind>();\nforeach (var value in values)\n{\n    var description = value.Attributes\n        .OfType<DescriptionAttribute>()\n        .First();\n    \n    Console.WriteLine($"{value.Name} => {description.Description}");\n}\n')),(0,a.kt)("h1",{id:"keyof"},"KeyOf"),(0,a.kt)("p",null,"The AOT.Reflection contains a way to express the intention safely when you want to pass the property inside the method. It works similarly to ",(0,a.kt)("inlineCode",{parentName:"p"},"keyof")," from TypeScript. Here is an example:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cs"},'using Apparatus.AOT.Reflection;\n\nvar user = new User {FirstName = "Jon", LastName = "Smith"};\nvar firstName = DoIt (user, "FirstName"); // no error\nvar lastName = DoIt (user, "LastName"); // no error\nvar missingProperty = DoIt (user, "Test"); // compilation error\n\n\nobject DoIt <T> (T value, KeyOf <T> propertyName)\n{\n     var property = value.GetProperties () [propertyName];\n     if (property.TryGetValue (value, out var propertyValue))\n     {\n         return propertyValue;\n     }\n\n     return null;\n}\n\nclass User\n{\n     public string FirstName {get; set; }\n     public string LastName {get; set; }\n}\n')),(0,a.kt)("p",null,"More information you can find in separate ",(0,a.kt)("a",{parentName:"p",href:"https://dev.to/byme8/improving-c-with-typescript-keyof-t-1jea"},"article"),"."),(0,a.kt)("h1",{id:"performance"},"Performance"),(0,a.kt)("p",null,"Let's imagine that we need to find a property with ",(0,a.kt)("inlineCode",{parentName:"p"},"Required")," attribute and the name  ",(0,a.kt)("inlineCode",{parentName:"p"},"FirstName"),".\nIf it exists, then print the value of the property, otherwise return the empty string. The implementation will be messy because I don't want to measure the LINQ performance, but the overall idea must be clear."),(0,a.kt)("p",null,"Here is the source code with default reflection:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cs"},"var type = _user.GetType();\nvar property = type.GetProperty(nameof(User.FirstName));\n\nvar required = false;\nforeach (var o in property.GetCustomAttributes())\n{\n    if (o.GetType() == typeof(RequiredAttribute))\n    {\n        required = true;\n        break;\n    }\n}\n\nif (required)\n{\n    return (string)property.GetMethod?.Invoke(_user, null);\n}\n\nreturn string.Empty;\n\n")),(0,a.kt)("p",null,"Here the source code with aot reflection:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cs"},"var entries = _user.GetProperties();\nvar firstName = entries[nameof(User.FirstName)];\n\nvar required = false;\nforeach (var o in firstName.Attributes)\n{\n    if (o is RequiredAttribute)\n    {\n        required = true;\n        break;\n    }\n}\n\nif (required)\n{\n    if (firstName.TryGetValue(_user, out var value))\n    {\n        return (string)value;\n    }\n\n    return string.Empty;\n}\n\nreturn string.Empty;\n")),(0,a.kt)("p",null,"Here are the benchmark results:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"BenchmarkDotNet=v0.13.1, OS=Windows 10.0.19043.1165 (21H1/May2021Update)\n11th Gen Intel Core i7-11700KF 3.60GHz, 1 CPU, 16 logical and 8 physical cores\n.NET SDK=6.0.100-preview.7.21379.14\n  [Host]     : .NET 5.0.7 (5.0.721.25508), X64 RyuJIT\n  DefaultJob : .NET 5.0.7 (5.0.721.25508), X64 RyuJIT\n\n\n|        Method |        Mean |    Error |   StdDev |  Gen 0 | Allocated |\n|-------------- |------------:|---------:|---------:|-------:|----------:|\n|    Reflection | 1,758.91 ns | 2.714 ns | 2.406 ns | 0.1278 |   1,072 B |\n| AOTReflection |    16.01 ns | 0.090 ns | 0.075 ns |      - |         - |\n")),(0,a.kt)("p",null,"As you can see, the AOT.Reflection is significantly faster comparing to default reflection."),(0,a.kt)("p",null,"Now let's have a look at enums performance. Imagine that we have the enum value, and we need to get a description associated with it.\nHere how it will look:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cs"},'var attributes = _account.GetEnumValueInfo().Attributes;\nfor (int i = 0; i < attributes.Length; i++)\n{\n    var attribute = attributes[i];\n    if (attribute is DescriptionAttribute descriptionAttribute)\n    {\n        return descriptionAttribute.Description;\n    }\n}\n\nreturn "";\n')),(0,a.kt)("p",null,"Here is the results:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cs"},"|              Method |       Mean |     Error |    StdDev |  Gen 0 | Allocated |\n|-------------------- |-----------:|----------:|----------:|-------:|----------:|\n|        GetValuesAOT |   6.253 ns | 0.0394 ns | 0.0329 ns |      - |         - |\n| GetValuesReflection | 734.563 ns | 2.3173 ns | 1.9351 ns | 0.0324 |     272 B |\n")),(0,a.kt)("p",null,"And again, the AOT reflection works much faster."),(0,a.kt)("p",null,"The complete source code of benchmarks you can find ",(0,a.kt)("a",{parentName:"p",href:"https://github.com/byme8/Apparatus.AOT.Reflection/blob/master/src/Apparatus.AOT.Reflection.Benchmark/Program.cs"},"here"),"."),(0,a.kt)("h1",{id:"limitations"},"Limitations"),(0,a.kt)("p",null,"I would recommend being careful when you try to use these APIs inside the generic methods because, at this point, there is no easy way to analyze them and identify the correct signatures. It means the source generation will not happen. As a result, we will have an error at runtime.\nLet's have a look at the following sample:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cs"},"public class Program\n{\n    public static string? GetDescription<T>(T enumValue)\n        where T : Enum\n    {\n        return enumValue\n            .GetEnumValueInfo()\n            .Attributes\n            .OfType<DescriptionAttribute>()\n            .FirstOrDefault()\n            ?.Description;\n    }\n    \n    public static void Main()\n    {\n        var account = AccountKind.Admin;\n        Console.WriteLine(GetDescription(account));\n    }\n}\n")),(0,a.kt)("p",null,"We will have an exception if we run it because the source generator could not figure out the signatures. The type ",(0,a.kt)("inlineCode",{parentName:"p"},"T")," is the mystery for it.\nBut we can fix it with a small trick:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-cs"},"public class Program\n{\n    private void DontCallMe()\n    {\n        EnumHelper.GetEnumInfo<AccountKind>();\n    }\n    \n    public static string? GetDescription<T>(T enumValue)\n        where T : Enum\n    {\n        return enumValue\n            .GetEnumValueInfo()\n            .Attributes\n            .OfType<DescriptionAttribute>()\n            .FirstOrDefault()\n            ?.Description;\n    }\n    \n    public static void Main()\n    {\n        var account = AccountKind.Admin;\n        Console.WriteLine(GetDescription(account));\n    }\n}\n\n")),(0,a.kt)("p",null,"Pay attention to the ",(0,a.kt)("inlineCode",{parentName:"p"},"DontCallMe ")," method. We do not have any intention to use it anywhere. It is here to help the source generator to analyze the source code. Now, if we run it, everything works as expected.\nThe same issue exists for the properties reflection, and we can use the same trick to avoid it."),(0,a.kt)("h1",{id:"support"},"Support"),(0,a.kt)("p",null,"Right now, only public properties and enums are supported. Regarding the private members, I doubt them because they would ruin the performance, but we will see."))}m.isMDXComponent=!0}}]);